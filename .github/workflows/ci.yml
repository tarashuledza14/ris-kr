name: CI (Ruby & Docker)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true

    - name: Install dependencies
      run: bundle install

    - name: Check Ruby syntax
      run: bundle exec ruby -c config/boot.rb

  build-docker:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag my-todo-app:latest

  deploy:
    needs: build-docker
    # Цей рядок означає: деплоїмо тільки коли пушимо в гілку main
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to AWS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            # Заходимо в папку проекту
            cd todo_app-2
            
            # --- ВАЖЛИВО: ЖОРСТКЕ ОНОВЛЕННЯ ---
            # Забираємо інформацію про нову версію
            git fetch origin main
            # Примусово робимо код таким, як на GitHub (видаляючи будь-які конфлікти)
            git reset --hard origin/main
            
            # Перезбираємо і перезапускаємо контейнери
            docker compose up --build -d
            
            # Запускаємо міграції (прапор -T потрібен для неінтерактивного режиму)
            docker compose exec -T web bin/rails db:migrate
            
            # Чистимо старі образи, щоб звільнити місце на диску
            docker image prune -f