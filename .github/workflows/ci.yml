# name: CI

# on:
#   pull_request:
#   push:
#     branches: [ main ]

# jobs:
#   scan_ruby:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v5

#       - name: Set up Ruby
#         uses: ruby/setup-ruby@v1
#         with:
#           bundler-cache: true

#       - name: Scan for common Rails security vulnerabilities using static analysis
#         run: bin/brakeman --no-pager
      
#       - name: Scan for known security vulnerabilities in gems used
#         run: bin/bundler-audit
      
#   lint:
#     runs-on: ubuntu-latest
#     env:
#       RUBOCOP_CACHE_ROOT: tmp/rubocop
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v5

#       - name: Set up Ruby
#         uses: ruby/setup-ruby@v1
#         with:
#           bundler-cache: true

#       - name: Prepare RuboCop cache
#         uses: actions/cache@v4
#         env:
#           DEPENDENCIES_HASH: ${{ hashFiles('.ruby-version', '**/.rubocop.yml', '**/.rubocop_todo.yml', 'Gemfile.lock') }}
#         with:
#           path: ${{ env.RUBOCOP_CACHE_ROOT }}
#           key: rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-${{ github.ref_name == github.event.repository.default_branch && github.run_id || 'default' }}
#           restore-keys: |
#             rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-

#       - name: Lint code for consistent style
#         run: bin/rubocop -f github

#   test:
#     runs-on: ubuntu-latest

#     # services:
#     #  redis:
#     #    image: valkey/valkey:8
#     #    ports:
#     #      - 6379:6379
#     #    options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v5

#       - name: Set up Ruby
#         uses: ruby/setup-ruby@v1
#         with:
#           bundler-cache: true

#       - name: Run tests
#         env:
#           RAILS_ENV: test
#           # RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
#           # REDIS_URL: redis://localhost:6379/0
#         run: bin/rails db:test:prepare test

#   system-test:
#     runs-on: ubuntu-latest

#     # services:
#     #  redis:
#     #    image: valkey/valkey:8
#     #    ports:
#     #      - 6379:6379
#     #    options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v5

#       - name: Set up Ruby
#         uses: ruby/setup-ruby@v1
#         with:
#           bundler-cache: true

#       - name: Run System Tests
#         env:
#           RAILS_ENV: test
#           # RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
#           # REDIS_URL: redis://localhost:6379/0
#         run: bin/rails db:test:prepare test:system

#       - name: Keep screenshots from failed system tests
#         uses: actions/upload-artifact@v4
#         if: failure()
#         with:
#           name: screenshots
#           path: ${{ github.workspace }}/tmp/screenshots
#           if-no-files-found: ignore

name: CI (Ruby & Docker)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true

    - name: Install dependencies
      run: bundle install

    # Тут міг бути запуск тестів (rspec), але поки просто перевіримо, чи код валідний
    - name: Check Ruby syntax
      run: bundle exec ruby -c config/boot.rb

  build-docker:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag my-todo-app:latest
      # ... тут твої попередні джоби (test / build) ...

  deploy:
    needs: test # <--- ВАЖЛИВО! Деплой буде ТІЛЬКИ якщо тести пройшли
    if: github.ref == 'refs/heads/main' # Тільки коли пушимо в main
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to AWS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            # Заходимо в папку проекту на сервері
            cd todo_app-2
            
            # Забираємо свіжий код
            git pull origin main
            
            # Перезбираємо і перезапускаємо (як ми робили вручну)
            docker compose up --build -d
            
            # Чистимо старі образи, щоб місце не закінчилось
            docker image prune -f